{% liquid
  assign padding_top = section.settings.padding_top
  assign padding_bottom = section.settings.padding_bottom
  assign margin_top = section.settings.margin_top
  assign margin_bottom = section.settings.margin_bottom
  assign background_color = section.settings.background_color
%}

{% style %}
  .section-{{ section.id }} {
    margin-top: {{ margin_top | times: 0.75 | round: 0 }}px;
    margin-bottom: {{ margin_bottom | times: 0.75 | round: 0 }}px;
  }
  
  .section-{{ section.id }}-settings {
    margin: 0 auto;
    padding-top: {{ padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ padding_bottom | times: 0.75 | round: 0 }}px;
  }

  @media(min-width: 768px) {
    .section-{{ section.id }} {
      margin-top: {{ margin_top }}px;
      margin-bottom: {{ margin_bottom }}px;
    }
    
    .section-{{ section.id }}-settings {
      padding-top: {{ padding_top }}px;
      padding-bottom: {{ padding_bottom }}px;
    }
  }

  /* {% if section.settings.box_border %}
    .section-{{ section.id }} .masonry-grid-body {
      border: {{ section.settings.box_width}}px solid {{section.settings.border_color}};
    }
  {% endif %} */
{% endstyle %}

{% style %}
  * {
    box-sizing: border-box;
    padding: 0;
    margin: 0;
  }
  body.no-scroll {
    overflow: hidden;
  }
  .grid-item-wrap {
    width: 25%; /* Adjust the width to make 4 columns with some margin */
    box-sizing: border-box;
  }

  .masonry-grid-item {
    background-color: {{ section.settings.review_box_color }};
    margin: 7px;
    border-radius: 12px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    font-family: var(--font-body-family);
    opacity: 0;
    transform: translateY(20px); /* Start with a small downward shift */
    transition: opacity 0.4s ease, transform 0.4s ease; /* Smooth transition */
    overflow: hidden;
  }

  {% if section.settings.box_border %}
    .section-{{ section.id }} .masonry-grid-item {
      border: {{ section.settings.box_width}}px solid {{section.settings.border_color}};
    }
  {% endif %}

  .grid-item-wrap.loaded .masonry-grid-item {
    opacity: 1;
    transform: translateY(0); /* Bring back to original position */
  }

  .enable_lightbox .masonry-grid-item {
    cursor: pointer;
  }

  .grid-item-wrap img {
    width: 100%;
    border-radius: 12px 12px 0 0;
    object-fit: cover;
    cursor: zoom-in;
  }

  .enable_lightbox .masonry-grid-item img {
    cursor: zoom-in;
  }

  .grid-item-wrap .masonry-grid-item:hover {
    background-color: {{ section.settings.review_box_hover_color }};
  }

  .grid-item-wrap .masonry-grid-item:hover img {
    opacity: 0.9;
  }
  .hide_img {
    display: none;
  }
  .masonry-grid-body {
    padding: 15px 20px;
    border-radius: 0 0 12px;
  }
  .hide_img+.masonry-grid-body {
    border-radius: 12px;
  }
  .masonry-block_title {
    font-weight: 600;
    font-size: 16px;
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 0 8px;
    margin-bottom: 5px;
  }

  .masonry-block_title svg {
    width: 20px;
  }

  .masonry-block_title>div {
    line-height: 1;
  }

  .masonry-grid-body .masonry-block_title span {
    display: none;
  }

  .masonry-stars {
    margin-bottom: 10px;
    display: flex;
    gap: 2px;
  }

  .masonry-stars svg {
    fill: {{ section.settings.star_color }};
    width: 14px;
    height: auto;
  }

  .masonry-description {
    font-size: 14px;
    line-height: 19px;
  }

  .load-more-container {
    text-align: center;
    margin: 40px 0 20px;
    min-height: 36px;
    position: relative; /* Ensures stable positioning */
    z-index: 10; /* Prevents overlap with new items */
  }

  .load-more-btn {
    background-color: transparent;
    color: #282828;
    border: 1px solid #282828;
    border-radius: 16px;
    padding: 5px 20px;
    cursor: pointer;
    outline: none;
    will-change: transform;
    font-size: 14px;
    transition: all 0.3s ease;
  }

  .load-more-btn:hover {
    background-color: #000000;
    color: #ffffff;
  }

  /* Overlay styles */
  .item-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    display: none; /* Hidden by default */
    z-index: 1000;
  }

  #item-popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 80%;
    max-width: 813px;
    box-shadow: 0px 0px 35px -10px rgba(0, 0, 0, 0.25);
    z-index: 1000;
    border-radius: 8px;
  }

  #item-popup .popup-content {
    display: flex;
    justify-content: center;
    height: 555px;
  }

  #item-popup .close-popup {
    position: absolute;
    top: 15px;
    left: 15px;
    font-size: 22px;
    line-height: 1;
    cursor: pointer;
    height: 24px;
    width: 24px;
    background-color: rgba(0, 0, 0, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 5px;
    color: #ffffff;
    z-index: 11;
  }

  .popup-media {
    background-color: rgb(41, 33, 22);
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    border-radius: 8px 0px 0px 8px;
    position: relative;
    flex-basis: 53%;
  }

  .popup-main {
    flex-basis: 47%;
    flex-grow: 1;
    background-color: #ffffff;
    display: flex;
    flex-direction: column;
    padding: 24px;
    font-family: var(--font-body-family);
    border-radius: 0 8px 8px 0;
  }

  #item-popup img {
    width: 100%;
    height: auto;
    object-fit: cover;
    background-color: rgb(41, 33, 22);
    position: relative;
  }

  .popup-title-wrapper {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 4px;
  }

  .popup-title-wrapper .star-inner {
    display: flex;
    align-items: center;
    gap: 2px;
  }

  .popup-title-wrapper svg {
    width: 18px;
  }

  .popup-title-wrapper span {
    font-size: 12px;
    line-height: 18px;
    color: #767676;
  }

  #item-popup #popup-stars {
    display: flex;
    gap: 2px;
  }

  #item-popup #popup-stars svg {
    width: 18px;
    height: auto;
  }

  #item-popup h4 {
    margin: 0px;
    font-size: 16px;
    line-height: 24px;
    font-weight: 600;
  }

  .popup-review-details {
    margin-bottom: 16px;
  }

  #item-popup p {
    font-size: 15px;
    line-height: 22px;
  }

  @media screen and (max-width: 767px) {
    .grid-item-wrap {
      width: 50%;
    }
    .masonry-grid-item {
      border-radius: 8px;
    }
    .grid-item-wrap img {
      border-radius: 8px 8px 0 0;
    }
    #item-popup {
      width: 100%;
      max-width: 600px;
    }
    #item-popup .popup-content {
      flex-direction: column;
      justify-content: unset;  
      max-height: 90vh;
      height: 100%;
      overflow-y: auto;
    }
    .popup-media {
      flex-basis: auto;
      border-radius: 0;
    }
    #item-popup img {
      min-height: 100vw;
      max-height: 85vh;
    }
    .popup-main {
      width: 100%;
      border-radius: 0px;
    }
    #item-popup .close-popup {
      top: 20px;
      left: 20px;
      width: 30px;
      height: 30px;
      font-size: 26px;
    }
  }
{% endstyle %}

<div class="section-{{ section.id }} masonry-review-{{ section.id }}" style="background-color:{{ background_color }};">
  <div class="section-{{ section.id }}-settings page-width">
    <div class="masonry-grid{% if section.settings.enable_lightbox and section.settings.enable_image %} enable_lightbox{% endif %}">
      <!-- Initial items will be loaded by JavaScript -->
    </div>
    
    <div class="load-more-container">
      <button class="load-more-btn">Show more reviews</button>
    </div>
    
    <!-- overlay and popup -->
    <div class="item-overlay"></div>
    <div id="item-popup" style="display: none">
      <div class="popup-content">
        <span class="close-popup">&times;</span>
        <div class="popup-media">
          <img src="" width="100%" height="100%" alt="Item Image" id="popup-img" />
        </div>
        <div class="popup-main">
          <div class="popup-review-details">
            <div class="popup-title-wrapper">
            </div>
            <div id="popup-stars"></div>
          </div>
          <p id="popup-description"></p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Masonry JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/masonry/4.2.2/masonry.pkgd.min.js"></script>
<!-- ImagesLoaded JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js"></script>

<script>
  function initMasonry() {
    const items = [
      {% for block in section.blocks %}
        {
          {% if block.settings.item_image != blank %}
            img: "{{ block.settings.item_image | image_url: width: 450 }}",
          {% else %}
            img: null,
          {% endif %}
          imgRatio: "{{ block.settings.image_ratio }}",
          title: "{{ block.settings.item_title }}",
          verify: "{{ block.settings.enable_verified }}",
          stars: "{{ block.settings.stars }}",
          description: "{{ block.settings.item_description }}",
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ];
  
    let itemsLoaded = 0;
    const itemsPerPage = {{ section.settings.item_per_load }};
    const $grid = $(".masonry-grid");
  
    function createVerificationBadge() {
      return `
        <div class="star-inner">
          <svg 
            width='24' height='24' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'
            ><rect width='24' height='24' stroke='none' fill='#000000' opacity='0'/>
            <g transform="matrix(0.42 0 0 0.42 12 12)" >
              <g style="" >
                <g transform="matrix(1 0 0 1 0 0)" >
                  <polygon style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-dashoffset: 0; stroke-linejoin: miter; stroke-miterlimit: 4; fill: rgb(66,165,245); fill-rule: nonzero; opacity: 1;" points="5.62,-21 9.05,-15.69 15.37,-15.38 15.69,-9.06 21,-5.63 18.12,0 21,5.62 15.69,9.05 15.38,15.37 9.06,15.69 5.63,21 0,18.12 -5.62,21 -9.05,15.69 -15.37,15.38 -15.69,9.06 -21,5.63 -18.12,0 -21,-5.62 -15.69,-9.05 -15.38,-15.37 -9.06,-15.69 -5.63,-21 0,-18.12 " />
                </g>
                <g transform="matrix(1 0 0 1 -0.01 0.51)" >
                  <polygon style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-dashoffset: 0; stroke-linejoin: miter; stroke-miterlimit: 4; fill: rgb(255,255,255); fill-rule: nonzero; opacity: 1;" points="-2.6,6.74 -9.09,0.25 -6.97,-1.87 -2.56,2.53 7,-6.74 9.09,-4.59 " />
                </g>
              </g>
            </g>
          </svg>
          <span>Verified purchase</span>
        </div>
      `;
    }
  
    function createStarIcon(n) {
      let stars = '';
      for (let i = 0; i < n; i++) {
        stars += `
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
            <path d="M12 .587l3.668 7.568 8.332 1.151-6.064 5.828 1.48 8.279-7.416-3.967-7.417 3.967 1.481-8.279-6.064-5.828 8.332-1.151z"/>
          </svg>
        `;
      }
      return stars;
    }

    function createImage(item) {
      let cls = "";
      if(item.img == null)
        cls = "hide_img";
      return `
        <img class="${cls}" src="${item.img}" alt="${item.title}" style="aspect-ratio: ${item.imgRatio}">
      `;
    }
  
    function createItemHTML(item, index) {
      return `
        <div class="grid-item-wrap">
          <div class="masonry-grid-item" data-id="${index}">
            {% if section.settings.enable_image %}${createImage(item)}{% endif %}
            <div class="masonry-grid-body">
              <div class="masonry-block_title">
                <div class="masonry_title">${item.title}</div>
                ${item.verify ? createVerificationBadge() : ""}
              </div>
              <div class="masonry-stars">
                ${createStarIcon(item.stars)}
              </div>
              <div class="masonry-description">${item.description}</div>
            </div>
          </div>
        </div>
      `;
    }
  
    function loadItems() {
      const itemsToLoad = items.slice(
        itemsLoaded,
        itemsLoaded + itemsPerPage
      );
      const $newItems = $(
        itemsToLoad
          .map((item, index) => createItemHTML(item, itemsLoaded + index))
          .join("")
      );
      $grid.append($newItems);
  
      // Ensure images are loaded before applying transition
      $newItems.imagesLoaded(function () {
        $newItems.addClass("loaded"); // Add a class to make them visible
        $grid.masonry("appended", $newItems).masonry("layout");
      });
  
      itemsLoaded += itemsPerPage;
  
      if (itemsLoaded >= items.length) {
        $(".load-more-btn").hide();
      }
    }
  
    $grid.imagesLoaded(function () {
      $grid.masonry({
        itemSelector: ".grid-item-wrap",
        columnWidth: ".grid-item-wrap",
        percentPosition: true,
      });
  
      // Load initial items
      loadItems();
    });
  
    // Load more items on button click
    $(".load-more-btn").on("click", loadItems);

    // Handle item click to open popup
    {% if section.settings.enable_lightbox and section.settings.enable_image %}
      $grid.on("click", ".masonry-grid-item", function () {
        const itemId = $(this).data("id");
        const item = items[itemId];
        
        if(item.img == null)
          $("#popup-img").attr("class", 'hide_img');
        else
          $("#popup-img").attr("src", item.img);
        $(".popup-title-wrapper").html($(this).find(".masonry-block_title").html());
        $("#popup-description").text(item.description);
        $("#popup-stars").html($(this).find(".masonry-stars").html());
    
        $(".item-overlay, #item-popup").fadeIn();
        $("body").addClass("no-scroll"); // Disable scrolling
      });
    
      // Handle closing the popup
      function closePopup() {
        $(".item-overlay, #item-popup").fadeOut();
        $("body").removeClass("no-scroll"); // Re-enable scrolling
      }
    
      $(".item-overlay").on("click", closePopup);
      $(".close-popup").on("click", closePopup);
    {% endif %}
  
  }

  {% if request.design_mode %}
    document.addEventListener('DOMContentLoaded', initMasonry);
    document.addEventListener("shopify:section:load", initMasonry);
    document.addEventListener('shopify:block:select', initMasonry);
    document.addEventListener('shopify:section:load', initMasonry);
    document.addEventListener('shopify:section:unload', initMasonry);
    document.addEventListener('shopify:section:select', initMasonry);
    document.addEventListener('shopify:section:deselect', initMasonry);
  {% endif %}
  
  $(document).ready(initMasonry);
</script>

{% schema %}
  {
    "name": "Masonry Review",
    "tag": "section",
    "class": "masonry-review",
    "settings": [
      {
        "type": "header",
        "content": "Section Settings"
      },
      {
        "type": "number",
        "id": "item_per_load",
        "label": "Review per load",
        "default": 8
      },
      {
        "type": "text",
        "id": "load_more_text",
        "label": "Load More",
        "default": "Show more reviews"
      },
      {
        "type": "checkbox",
        "id": "enable_lightbox",
        "label": "Enable Lightbox",
        "default": true
      },
      {
        "type": "checkbox",
        "id": "enable_image",
        "label": "Enable Image",
        "default": true
      },
      {
        "type": "checkbox",
        "id": "box_border",
        "label": "Box Border",
        "default": false
      },
      {
        "type": "number",
        "id": "box_width",
        "label": "Border width",
        "default": 1,
        "info": "px"
      },
      {
        "type": "color",
        "label": "Border color",
        "id": "border_color",
        "default": "#000000"
      },
      {
        "type": "header",
        "content": "Colors"
      },
      {
        "type": "color",
        "label": "Section Background color",
        "id": "background_color",
        "default": "#fef7ea"
      },
      {
        "type": "color",
        "label": "Review box color",
        "id": "review_box_color",
        "default": "#ffffff"
      },
      {
        "type": "color",
        "label": "Review box hover color",
        "id": "review_box_hover_color",
        "default": "#f0f0f0"
      },
      {
        "type": "color",
        "label": "Star color",
        "id": "star_color",
        "default": "#222222"
      },
      {
        "type": "header",
        "content": "Section Margin (outside)"
      },
      {
        "type": "range",
        "id": "margin_top",
        "min": 0,
        "max": 100,
        "step": 4,
        "unit": "px",
        "label": "Margin Top",
        "default": 0
      },
      {
        "type": "range",
        "id": "margin_bottom",
        "min": 0,
        "max": 100,
        "step": 4,
        "unit": "px",
        "label": "Margin Bottom",
        "default": 0
      },
      {
        "type": "header",
        "content": "Section Padding (inside)"
      },
      {
        "type": "range",
        "id": "padding_top",
        "min": 0,
        "max": 100,
        "step": 4,
        "unit": "px",
        "label": "Padding Top",
        "default": 32
      },
      {
        "type": "range",
        "id": "padding_bottom",
        "min": 0,
        "max": 100,
        "step": 4,
        "unit": "px",
        "label": "Padding Bottom",
        "default": 32
      }
    ],
    "blocks": [
      {
        "type": "item",
        "name": "Item",
        "settings": [
          {
            "type": "image_picker",
            "id": "item_image",
            "label": "Item Image"
          },
          {
            "type": "select",
            "id": "image_ratio",
            "label": "Image Ratio",
            "options": [
              {
                "value": "4/5",
                "label": "4:5"
              },
              {
                "value": "1",
                "label": "1:1"
              },
              {
                "value": "16/9",
                "label": "16:9"
              }
            ],
            "default": "4/5"
          },
          {
            "type": "text",
            "id": "item_title",
            "label": "Author",
            "default": "Author"
          },
          {
            "type": "checkbox",
            "id": "enable_verified",
            "label": "Enable verified",
            "default": true
          },
          {
            "type": "select",
            "id": "stars",
            "label": "Stars",
            "options": [
              {
                "value": "5",
                "label": "5"
              },
              {
                "value": "4",
                "label": "4"
              },
              {
                "value": "3",
                "label": "3"
              },
              {
                "value": "2",
                "label": "2"
              },
              {
                "value": "1",
                "label": "1"
              }
            ],
            "default": "5"
          },
          {
            "type": "textarea",
            "id": "item_description",
            "label": "Item Description",
            "default": "Item description goes here."
          }
        ]
      }
    ],
    "presets": [
      {
        "name": "Masonry Review",
        "category": "Custom",
        "blocks": [
          {
            "type": "item",
            "settings": {
              "item_title": "Claire C.",
              "item_description": "The product is phenom and smells great! I am allergic to SO many typical skincare ingredients and I have problems with almost every new product I try. I have not had a single problem with this one"
            }
          },
          {
            "type": "item",
            "settings": {
              "item_title": "Brianna P.",
              "item_description": "This eye cream worked wonders for me!"
            }
          },
          {
            "type": "item",
            "settings": {
              "item_title": "Sharon J.",
              "item_description": "It's working wonders for my dark spots and blemishes!"
            }
          },
          {
            "type": "item",
            "settings": {
              "item_title": "Nicole G.",
              "item_description": "My under eye area was definitely hydrated after application and I didn’t look as tired. Good stuff!"
            }
          },
          {
            "type": "item",
            "settings": {
              "item_title": "Taylor F.",
              "item_description": "One of my absolute favourite brands has just come out with an incredible new eye cream!!! I am one very happy gal!"
            }
          },
          {
            "type": "item",
            "settings": {
              "item_title": "Amanda B.",
              "item_description": "Athena Eye Cream is the best and makes your skin feel so GOOD and refreshing!!"
            }
          },
          {
            "type": "item",
            "settings": {
              "item_title": "Hannah C.",
              "item_description": "This eye cream has provided so much hydration that for the first time in years I’m not experiencing dry flaky skin on my face. It smells great. My only concern is if you are sensitive to fragrance be cautious that the scent is strong. Overall love the product!"
            }
          },
          {
            "type": "item",
            "settings": {
              "item_title": "Antonia P.",
              "item_description": "Ich liebe diese Wimpern und Dank dem Kleber von Girlsgodlashes, halten sie bei mir mindestens 7 Tage. Ich will nie wieder etwas anderes 🥰"
            }
          }
        ]
      }
    ]
  }
{% endschema %}

