<script>
  // âœ… Listen globally for cart updates
  document.addEventListener('cart:updated', (e) => {
    const cart = e.detail;
    console.log('ðŸ›’ Cart updated globally:', cart);

    // Do your theme-level updates here
    rerenderCart(cart);
  });

  // âœ… Emit cart:updated after modifying cart
  async function emitCartUpdated() {
    try {
      const res = await fetch('/cart.js', { cache: 'no-cache' });
      const newCart = await res.json();

      // Dispatch a global event so any page can listen to it
      document.dispatchEvent(new CustomEvent('cart:updated', { detail: newCart }));

    } catch (error) {
      console.error('Failed to emit cart update:', error);
    }
  }

  // âœ… Example: Add a free gift to cart and trigger update
  function addFreeGift(variantId) {
    fetch('/cart/add.json', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Cache-Control': 'no-cache'
      },
      body: JSON.stringify({
        id: variantId,
        quantity: 1,
        properties: { _free_gift: true }
      })
    })
    .then(forceSectionRerender) // your custom section update
    .then(emitCartUpdated)      // ðŸ”¥ now emit globally
    .finally(endGiftAddGuard);
  }

  // âœ… Your cart rerender handler
  function rerenderCart(cart) {
    // Example action
    console.log(`There are ${cart.item_count} items in the cart.`);
    // TODO: Update mini-cart, free gift bar, etc.
  }
</script>

